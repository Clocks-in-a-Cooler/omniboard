var form=document.getElementById("login_form"),socket=io();form.addEventListener("submit",function(a){a.preventDefault(),console.log("name: "+form.username.value),socket.emit("login",{name:form.username.value})});function create_sprite(a){var b=document.createElement("img");return b.src=a,b}var orange_pencil=create_sprite("pencil_orange.png"),blue_pencil=create_sprite("pencil_blue.png"),eraser=create_sprite("eraser.png"),image_layer=document.getElementById("image_layer"),image_cxt=image_layer.getContext("2d"),control_layer=document.getElementById("control_layer"),control_cxt=control_layer.getContext("2d");image_layer.width=control_layer.width=window.innerWidth-400,image_layer.height=control_layer.height=window.innerHeight;var chat=document.getElementById("chat"),controls=document.getElementById("controls");function create_rbutton_group(a,c){var d=a.childNodes;d.forEach(a=>{a.addEventListener("click",()=>{d.forEach(a=>{a.className="rbutton"}),a.className+=" selected",c(a.id)})})}var draw_size=1,mouse={clicking:!1,pos:{x:null,y:null},click:function(){console.log("mouse click at ("+mouse.pos.x+", "+mouse.pos.y+")")},scroll:function(a){var b=mouse.find_scroll_direction(a);"down"==b?(draw_size-=.1,draw_size=Math.max(draw_size,.2)):(draw_size+=.1,draw_size=Math.min(draw_size,5))},find_scroll_direction:function(a){var b;return(b=a.wheelDelta?a.wheelDelta:-1*a.deltaY,0>b)?"down":0<b?"up":void 0}};function addEventListeners(){addEventListener("mousedown",function(){mouse.clicking=!0}),addEventListener("mouseup",function(){mouse.clicking=!1}),addEventListener("mousemove",function(a){mouse.pos={x:a.clientX,y:a.clientY}}),addEventListener("click",mouse.click),addEventListener("wheel",mouse.scroll),document.getElementById("download").addEventListener("click",()=>{save_image()})}var others=[];function draw_others(){control_cxt.fillStyle="dodgerblue",control_cxt.font="12pt sans-serif",control_cxt.textBaseline="top",control_cxt.textAlign="center",others.forEach(a=>{switch(a.tool){case"pencil":control_cxt.drawImage(blue_pencil,a.x,a.y-30);break;case"eraser":control_cxt.drawImage(eraser,a.x,a.y-30);}control_cxt.fillText(a.name,a.x,a.y+3)})}var tools={pencil:{last_pos:null,update:function(){mouse.clicking?(null!=this.last_pos&&(image_cxt.fillStyle=image_cxt.strokeStyle=current_colour,image_cxt.lineWidth=draw_size,image_cxt.beginPath(),image_cxt.moveTo(this.last_pos.x,this.last_pos.y),image_cxt.lineTo(mouse.pos.x,mouse.pos.y),image_cxt.closePath(),image_cxt.stroke(),image_cxt.beginPath(),image_cxt.moveTo(this.last_pos.x,this.last_pos.y),image_cxt.arc(this.last_pos.x,this.last_pos.y,.5*draw_size,0,2*Math.PI),image_cxt.moveTo(mouse.pos.x,mouse.pos.y),image_cxt.arc(mouse.pos.x,mouse.pos.y,.5*draw_size,0,2*Math.PI),image_cxt.closePath(),image_cxt.fill(),socket.emit("drawing",{colour:current_colour,tool:"pencil",start:this.last_pos,end:mouse.pos,size:draw_size})),this.last_pos=mouse.pos):this.last_pos=null,draw_others(),control_cxt.drawImage(orange_pencil,mouse.pos.x,mouse.pos.y-30)},draw:function(a){image_cxt.strokeStyle=image_cxt.fillStyle=a.colour,image_cxt.lineWidth=a.size,image_cxt.beginPath(),image_cxt.moveTo(a.start.x,a.start.y),image_cxt.lineTo(a.end.x,a.end.y),image_cxt.closePath(),image_cxt.stroke(),image_cxt.beginPath(),image_cxt.moveTo(a.start.x,a.start.y),image_cxt.arc(a.start.x,a.start.y,a.size/2,0,2*Math.PI),image_cxt.moveTo(a.end.x,a.end.y),image_cxt.arc(a.end.x,a.end.y,a.size/2,0,2*Math.PI),image_cxt.closePath(),image_cxt.fill()}},eraser:{update:function(){var a=this.get_size(draw_size);mouse.clicking&&(image_cxt.clearRect(mouse.pos.x-a,mouse.pos.y-a,2*a,2*a),socket.emit("drawing",{size:draw_size,tool:"eraser",x:mouse.pos.x,y:mouse.pos.y})),control_cxt.strokeStyle="black",control_cxt.lineWidth=2,control_cxt.strokeRect(mouse.pos.x-a,mouse.pos.y-a,2*a,2*a),draw_others()},get_size:function(a){return 3.64*a+1.77},draw:function(a){var b=this.get_size(a.size);image_cxt.clearRect(a.x-b,a.y-b,2*b,2*b)}}},current_colour="dodgerblue",current_tool="pencil";create_rbutton_group(document.getElementById("colour_controls"),a=>{current_colour=a}),create_rbutton_group(document.getElementById("tools"),a=>{current_tool=a});function save_image(){var a=document.createElement("a");a.download="omniboard.png",a.href=image_layer.toDataURL(),a.click()}function toggle_controls(){var a=controls.style.visibility;controls.style.visibility="hidden"==a?"visible":"hidden"}var send_message=document.getElementById("send_message");send_message.addEventListener("submit",function(a){a.preventDefault(),socket.emit("send message",send_message.message.value),add_message(send_message.message.value,"my_message"),send_message.message.value=""});var messages_panel=document.getElementById("messages");function add_message(a,b){var c=document.createElement("div");c.className=b,c.innerHTML=a,messages_panel.appendChild(c),messages_panel.scrollTo(0,messages_panel.scrollHeight)}socket.on("logged in",a=>{document.body.removeChild(document.getElementById("mask")),document.body.removeChild(document.getElementById("login_box"));var b=new Image;b.src=a.image,b.onload=function(){image_cxt.drawImage(b,0,0)},addEventListeners(),requestAnimationFrame(cycle)}),socket.on("server update",a=>{others=a}),socket.on("draw",a=>{switch(a.tool){case"pencil":tools.pencil.draw(a);break;case"eraser":tools.eraser.draw(a);}}),socket.on("incoming message",function(a){add_message(a,"message")}),socket.on("notification",function(a){add_message(a,"notification")});function cycle(){control_cxt.clearRect(0,0,control_layer.width,control_layer.height),tools[current_tool].update(),socket.emit("position update",{pos:mouse.pos,tool:current_tool}),requestAnimationFrame(cycle)}
